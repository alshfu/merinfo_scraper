<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merinfo Universal Viewer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding: 20px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .card { border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 25px; transition: all 0.2s ease-in-out; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 6px 16px rgba(0,0,0,0.12); }
        .card-header { background-color: #fff; border-bottom: 1px solid #eee; padding: 15px 20px; }
        .section-title { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; color: #6c757d; margin-bottom: 12px; font-weight: 700; border-bottom: 2px solid #e9ecef; padding-bottom: 5px;}
        .data-label { font-weight: 600; color: #495057; }
        .profit-plus { color: #198754; font-weight: bold; }
        .profit-minus { color: #dc3545; font-weight: bold; }
        .status-active { color: #198754; background: #d1e7dd; padding: 3px 10px; border-radius: 15px; font-size: 0.85em; font-weight: 500; }
        .status-inactive { color: #842029; background: #f8d7da; padding: 3px 10px; border-radius: 15px; font-size: 0.85em; font-weight: 500; }
        .list-unstyled li { padding: 4px 0; }
        .board-member { border-top: 1px solid #f1f3f5; padding-top: 10px; margin-top: 10px; }
        .board-member:first-child { border-top: none; padding-top: 0; margin-top: 0; }

        @media print {
            body { background-color: #fff; padding: 0; font-size: 10pt; }
            .container-fluid { padding: 0; }
            .card { box-shadow: none; border: 1px solid #ddd; page-break-inside: avoid; margin-bottom: 15px; }
            .card:hover { transform: none; box-shadow: none; }
            .card-header { background-color: #f8f8f8; }
            .controls-card, #loading, #statusMsg, #lang-switcher { display: none; }
            h2.main-title { text-align: center; font-size: 16pt; }
            #recordCount { display: block; text-align: center; width: 100%; margin-bottom: 15px; }
            .status-active, .status-inactive { border: 1px solid #ccc; background: none !important; }
            .profit-plus, .profit-minus, .text-success, .text-danger { color: #000 !important; }
            a { text-decoration: none; color: #000; }
            .badge { border: 1px solid #ccc !important; background: none !important; color: #000 !important; }
        }
    </style>
</head>
<body>

    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center">
            <h2 class="mb-4 text-primary fw-bold main-title" data-translate="main_title">Merinfo Data Viewer</h2>
            <div class="btn-group mb-4" id="lang-switcher">
                <button type="button" class="btn btn-outline-secondary btn-sm" data-lang="ru">RU</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" data-lang="sv">SV</button>
            </div>
        </div>

        <div class="card p-4 mb-4 controls-card">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="fileInput" class="form-label fw-bold" data-translate="label_select_file">1. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª (JSON/JSONL)</label>
                    <input class="form-control" type="file" id="fileInput" accept=".json,.jsonl,.txt">
                </div>
                <div class="col-md-4">
                    <label for="searchInput" class="form-label fw-bold" data-translate="label_search">2. –ü–æ–∏—Å–∫</label>
                    <input type="text" class="form-control" id="searchInput" data-translate-placeholder="placeholder_search" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ, –Ω–æ–º–µ—Ä, –≥–æ—Ä–æ–¥..." disabled>
                </div>
                <div class="col-md-4">
                    <label for="sortSelect" class="form-label fw-bold" data-translate="label_sort">3. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
                    <select class="form-select" id="sortSelect" disabled>
                        <option value="name-asc" data-translate="sort_name_asc">–ù–∞–∑–≤–∞–Ω–∏–µ (–ê-–Ø)</option>
                        <option value="name-desc" data-translate="sort_name_desc">–ù–∞–∑–≤–∞–Ω–∏–µ (–Ø-–ê)</option>
                        <option value="revenue-desc" data-translate="sort_revenue_desc">–í—ã—Ä—É—á–∫–∞ (—É–±—ã–≤.)</option>
                        <option value="revenue-asc" data-translate="sort_revenue_asc">–í—ã—Ä—É—á–∫–∞ (–≤–æ–∑—Ä.)</option>
                        <option value="profit_after_financial_items-desc" data-translate="sort_profit_before_tax_desc">–ü—Ä–∏–±—ã–ª—å –¥–æ –Ω–∞–ª–æ–≥–æ–≤ (—É–±—ã–≤.)</option>
                        <option value="profit_after_financial_items-asc" data-translate="sort_profit_before_tax_asc">–ü—Ä–∏–±—ã–ª—å –¥–æ –Ω–∞–ª–æ–≥–æ–≤ (–≤–æ–∑—Ä.)</option>
                        <option value="net_profit-desc" data-translate="sort_net_profit_desc">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å (—É–±—ã–≤.)</option>
                        <option value="net_profit-asc" data-translate="sort_net_profit_asc">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å (–≤–æ–∑—Ä.)</option>
                        <option value="total_assets-desc" data-translate="sort_assets_desc">–ê–∫—Ç–∏–≤—ã (—É–±—ã–≤.)</option>
                        <option value="total_assets-asc" data-translate="sort_assets_asc">–ê–∫—Ç–∏–≤—ã (–≤–æ–∑—Ä.)</option>
                        <option value="date-desc" data-translate="sort_date_desc">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (–Ω–æ–≤—ã–µ)</option>
                        <option value="date-asc" data-translate="sort_date_asc">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (—Å—Ç–∞—Ä—ã–µ)</option>
                    </select>
                </div>
            </div>
             <div class="mt-3">
                <a class="btn btn-secondary btn-sm" data-bs-toggle="collapse" href="#collapseFilters" role="button" aria-expanded="false" aria-controls="collapseFilters" data-translate="advanced_filters">
                    <i class="bi bi-funnel"></i> –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
                </a>
            </div>
            <div class="collapse mt-3" id="collapseFilters">
                <div class="border p-3 rounded bg-light">
                    <div class="row g-3">
                        <div class="col-md-3 col-sm-6">
                            <label class="form-label small" data-translate="revenue">–í—ã—Ä—É—á–∫–∞</label>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control filter-input" id="revenue-min" data-translate-placeholder="min" placeholder="Min">
                                <input type="number" class="form-control filter-input" id="revenue-max" data-translate-placeholder="max" placeholder="Max">
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <label class="form-label small" data-translate="profit_before_tax">–ü—Ä–∏–±—ã–ª—å –¥–æ –Ω–∞–ª–æ–≥–æ–≤</label>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control filter-input" id="profit_after_financial_items-min" data-translate-placeholder="min" placeholder="Min">
                                <input type="number" class="form-control filter-input" id="profit_after_financial_items-max" data-translate-placeholder="max" placeholder="Max">
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <label class="form-label small" data-translate="net_profit">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</label>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control filter-input" id="net_profit-min" data-translate-placeholder="min" placeholder="Min">
                                <input type="number" class="form-control filter-input" id="net_profit-max" data-translate-placeholder="max" placeholder="Max">
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <label class="form-label small" data-translate="total_assets">–í—Å–µ–≥–æ –∞–∫—Ç–∏–≤–æ–≤</label>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control filter-input" id="total_assets-min" data-translate-placeholder="min" placeholder="Min">
                                <input type="number" class="form-control filter-input" id="total_assets-max" data-translate-placeholder="max" placeholder="Max">
                            </div>
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-3 col-sm-6">
                            <label class="form-label small" data-translate="company_phone">–¢–µ–ª–µ—Ñ–æ–Ω –∫–æ–º–ø–∞–Ω–∏–∏</label>
                            <select class="form-select form-select-sm filter-input" id="company-phone-filter">
                                <option value="any" data-translate="any">–õ—é–±–æ–π</option>
                                <option value="yes" data-translate="has_phone">–ï—Å—Ç—å</option>
                                <option value="no" data-translate="no_phone">–ù–µ—Ç</option>
                            </select>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <label class="form-label small" data-translate="board_phone">–¢–µ–ª–µ—Ñ–æ–Ω —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞</label>
                            <select class="form-select form-select-sm filter-input" id="board-phone-filter">
                                <option value="any" data-translate="any">–õ—é–±–æ–π</option>
                                <option value="yes" data-translate="has_phone">–ï—Å—Ç—å</option>
                                <option value="no" data-translate="no_phone">–ù–µ—Ç</option>
                            </select>
                        </div>
                         <div class="col-md-3 col-sm-6">
                            <label class="form-label small" data-translate="sni_description">SNI –û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <select id="sni-filter" multiple></select>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <label class="form-label small" data-translate="categories_filter">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</label>
                            <select id="category-filter" multiple></select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-3 d-flex justify-content-between text-muted small">
                <span id="statusMsg" data-translate="status_waiting">–û–∂–∏–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞...</span>
                <span id="recordCount"><span data-translate="records">–ó–∞–ø–∏—Å–µ–π</span>: 0</span>
            </div>
        </div>

        <div id="loading" class="text-center d-none my-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted" data-translate="status_analyzing">–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö...</p>
        </div>

        <div id="cardsContainer"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <script>
        const translations = {
            ru: {
                main_title: "üìä Merinfo Data Viewer",
                label_select_file: "1. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª (JSON/JSONL)",
                label_search: "2. –ü–æ–∏—Å–∫",
                label_sort: "3. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞",
                placeholder_search: "–ù–∞–∑–≤–∞–Ω–∏–µ, –Ω–æ–º–µ—Ä, –≥–æ—Ä–æ–¥...",
                sort_name_asc: "–ù–∞–∑–≤–∞–Ω–∏–µ (–ê-–Ø)",
                sort_name_desc: "–ù–∞–∑–≤–∞–Ω–∏–µ (–Ø-–ê)",
                sort_revenue_desc: "–í—ã—Ä—É—á–∫–∞ (—É–±—ã–≤.)",
                sort_revenue_asc: "–í—ã—Ä—É—á–∫–∞ (–≤–æ–∑—Ä.)",
                sort_profit_before_tax_desc: "–ü—Ä–∏–±—ã–ª—å –¥–æ –Ω–∞–ª–æ–≥–æ–≤ (—É–±—ã–≤.)",
                sort_profit_before_tax_asc: "–ü—Ä–∏–±—ã–ª—å –¥–æ –Ω–∞–ª–æ–≥–æ–≤ (–≤–æ–∑—Ä.)",
                sort_net_profit_desc: "–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å (—É–±—ã–≤.)",
                sort_net_profit_asc: "–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å (–≤–æ–∑—Ä.)",
                sort_assets_desc: "–ê–∫—Ç–∏–≤—ã (—É–±—ã–≤.)",
                sort_assets_asc: "–ê–∫—Ç–∏–≤—ã (–≤–æ–∑—Ä.)",
                sort_date_desc: "–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (–Ω–æ–≤—ã–µ)",
                sort_date_asc: "–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (—Å—Ç–∞—Ä—ã–µ)",
                status_waiting: "–û–∂–∏–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞...",
                records: "–ó–∞–ø–∏—Å–µ–π",
                status_analyzing: "–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö...",
                status_reading: "–ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞...",
                status_loaded: "–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã",
                status_error_format: "–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞.",
                status_error_read: "–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞",
                no_data: "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è",
                showing_first_500: "–ü–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ 500 –∑–∞–ø–∏—Å–µ–π. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫ –∏–ª–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É.",
                active: "–ê–∫—Ç–∏–≤–Ω–∞",
                unknown: "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ",
                yes: "–î–∞",
                no: "–ù–µ—Ç",
                no_board_data: "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–æ–≤–µ—Ç–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–æ–≤.",
                company_and_contacts: "üè¢ –ö–æ–º–ø–∞–Ω–∏—è –∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã",
                form: "–§–æ—Ä–º–∞:",
                registration: "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:",
                phone: "–¢–µ–ª–µ—Ñ–æ–Ω:",
                address: "–ê–¥—Ä–µ—Å:",
                city_county: "–ì–æ—Ä–æ–¥/–û–∫—Ä—É–≥:",
                taxes: "üßæ –ù–∞–ª–æ–≥–∏",
                employer: "–†–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å:",
                financials: "üí∞ –§–∏–Ω–∞–Ω—Å—ã",
                revenue: "–í—ã—Ä—É—á–∫–∞",
                profit_before_tax: "–ü—Ä–∏–±—ã–ª—å –¥–æ –Ω–∞–ª–æ–≥–æ–≤",
                net_profit: "–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å",
                total_assets: "–í—Å–µ–≥–æ –∞–∫—Ç–∏–≤–æ–≤",
                categories: "üè∑Ô∏è –ö–∞—Ç–µ–≥–æ—Ä–∏–∏",
                industry_and_board: "üè≠ –î–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ",
                sni_code: "SNI (–ö–æ–¥: {code})",
                board: "üë• –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ",
                years: "–ª–µ—Ç",
                advanced_filters: "–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã",
                min: "–ú–∏–Ω",
                max: "–ú–∞–∫—Å",
                company_phone: "–¢–µ–ª–µ—Ñ–æ–Ω –∫–æ–º–ø–∞–Ω–∏–∏",
                board_phone: "–¢–µ–ª–µ—Ñ–æ–Ω —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞",
                any: "–õ—é–±–æ–π",
                has_phone: "–ï—Å—Ç—å",
                no_phone: "–ù–µ—Ç",
                sni_description: "SNI –û–ø–∏—Å–∞–Ω–∏–µ",
                categories_filter: "–ö–∞—Ç–µ–≥–æ—Ä–∏–∏",
                select_placeholder: "–í—ã–±–µ—Ä–∏—Ç–µ..."
            },
            sv: {
                main_title: "üìä Merinfo Data Viewer",
                label_select_file: "1. V√§lj fil (JSON/JSONL)",
                label_search: "2. S√∂k",
                label_sort: "3. Sortering",
                placeholder_search: "Namn, organisationsnummer, stad...",
                sort_name_asc: "Namn (A-√ñ)",
                sort_name_desc: "Namn (√ñ-A)",
                sort_revenue_desc: "Oms√§ttning (fallande)",
                sort_revenue_asc: "Oms√§ttning (stigande)",
                sort_profit_before_tax_desc: "Resultat e. fin. (fallande)",
                sort_profit_before_tax_asc: "Resultat e. fin. (stigande)",
                sort_net_profit_desc: "√Örets resultat (fallande)",
                sort_net_profit_asc: "√Örets resultat (stigande)",
                sort_assets_desc: "Tillg√•ngar (fallande)",
                sort_assets_asc: "Tillg√•ngar (stigande)",
                sort_date_desc: "Registreringsdatum (nya)",
                sort_date_asc: "Registreringsdatum (gamla)",
                status_waiting: "V√§ntar p√• fil...",
                records: "Poster",
                status_analyzing: "Analyserar data...",
                status_reading: "L√§ser fil...",
                status_loaded: "Data har laddats framg√•ngsrikt",
                status_error_format: "Fel: Kunde inte tolka filformatet.",
                status_error_read: "Fel vid fill√§sning",
                no_data: "Ingen data att visa",
                showing_first_500: "Visar de f√∂rsta 500 posterna. Anv√§nd s√∂k eller sortering.",
                active: "Aktivt",
                unknown: "Ok√§nd",
                yes: "Ja",
                no: "Nej",
                no_board_data: "Inga uppgifter om styrelsen.",
                company_and_contacts: "üè¢ F√∂retag och kontakt",
                form: "Bolagsform:",
                registration: "Registrerat:",
                phone: "Telefon:",
                address: "Adress:",
                city_county: "Ort/L√§n:",
                taxes: "üßæ Skatter",
                employer: "Arbetsgivare:",
                financials: "üí∞ Ekonomi",
                revenue: "Oms√§ttning",
                profit_before_tax: "Resultat e. fin.",
                net_profit: "√Örets resultat",
                total_assets: "Summa tillg√•ngar",
                categories: "üè∑Ô∏è Kategorier",
                industry_and_board: "üè≠ Verksamhet och styrelse",
                sni_code: "SNI (Kod: {code})",
                board: "üë• Styrelse",
                years: "√•r",
                advanced_filters: "Avancerade filter",
                min: "Min",
                max: "Max",
                company_phone: "F√∂retagstelefon",
                board_phone: "Styrelsetelefon",
                any: "Alla",
                has_phone: "Har telefon",
                no_phone: "Ingen telefon",
                sni_description: "SNI-beskrivning",
                categories_filter: "Kategorier",
                select_placeholder: "V√§lj..."
            }
        };

        let currentLang = localStorage.getItem('merinfo_lang') || 'ru';
        let allData = [];
        let sniSelect, categorySelect;

        const fileInput = document.getElementById('fileInput');
        const searchInput = document.getElementById('searchInput');
        const sortSelect = document.getElementById('sortSelect');
        const cardsContainer = document.getElementById('cardsContainer');
        const loading = document.getElementById('loading');
        const recordCount = document.getElementById('recordCount');
        const statusMsg = document.getElementById('statusMsg');
        const sekFormatter = new Intl.NumberFormat('sv-SE', { style: 'currency', currency: 'SEK', maximumFractionDigits: 0 });

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('merinfo_lang', lang);
            document.documentElement.lang = lang;

            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                el.textContent = translations[lang][key] || el.textContent;
            });
            
            document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
                const key = el.getAttribute('data-translate-placeholder');
                el.placeholder = translations[lang][key] || el.placeholder;
            });

            document.querySelectorAll('#lang-switcher button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) btn.classList.add('active');
            });
            
            if (allData.length > 0) {
                populateAndInitSelects();
                sortAndRender();
            }
        }

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            loading.classList.remove('d-none');
            cardsContainer.innerHTML = '';
            document.querySelectorAll('.filter-input, #searchInput, #sortSelect, #sni-filter, #category-filter').forEach(el => el.disabled = true);
            statusMsg.textContent = translations[currentLang].status_reading;

            const reader = new FileReader();
            reader.onload = (event) => {
                const success = parseUniversal(event.target.result);
                loading.classList.add('d-none');
                if (success) {
                    document.querySelectorAll('.filter-input, #searchInput, #sortSelect, #sni-filter, #category-filter').forEach(el => el.disabled = false);
                    statusMsg.textContent = translations[currentLang].status_loaded;
                    populateAndInitSelects();
                    sortAndRender();
                } else {
                    statusMsg.innerHTML = `<span class='text-danger'>${translations[currentLang].status_error_format}</span>`;
                }
            };
            reader.onerror = () => {
                 loading.classList.add('d-none');
                 statusMsg.textContent = translations[currentLang].status_error_read;
            };
            reader.readAsText(file);
        });

        function parseUniversal(text) {
            allData = [];
            let successfullyParsedLines = 0;

            try {
                const json = JSON.parse(text);
                successfullyParsedLines = 1; 
                if (Array.isArray(json)) {
                    allData = json.filter(item => item && item.company && item.company.name);
                } else if (json && json.company && json.company.name) {
                    allData = [json];
                }
            } catch (e1) {
                const lines = text.split('\n');
                lines.forEach(line => {
                    const trimmed = line.trim();
                    if (trimmed) {
                        try {
                            const parsed = JSON.parse(trimmed);
                            successfullyParsedLines++; 
                            if (parsed && parsed.company && parsed.company.name) {
                                allData.push(parsed); 
                            }
                        } catch (e2) { /* ignore broken lines */ }
                    }
                });
            }
            return successfullyParsedLines > 0;
        }

        function populateAndInitSelects() {
            const sniOptions = new Set();
            const categoryOptions = new Set();

            allData.forEach(item => {
                if (item.industry?.sni_description) {
                    item.industry.sni_description.split('\n').forEach(desc => {
                        if (desc.trim()) sniOptions.add(desc.trim());
                    });
                }
                if (item.industry?.categories) {
                    item.industry.categories.forEach(cat => {
                        if (cat.trim()) categoryOptions.add(cat.trim());
                    });
                }
            });

            if (sniSelect) sniSelect.destroy();
            if (categorySelect) categorySelect.destroy();

            const tomSelectSettings = {
                plugins: ['remove_button'],
                placeholder: translations[currentLang].select_placeholder,
                create: false,
            };

            sniSelect = new TomSelect('#sni-filter', { ...tomSelectSettings, options: Array.from(sniOptions).map(o => ({value: o, text: o})) });
            categorySelect = new TomSelect('#category-filter', { ...tomSelectSettings, options: Array.from(categoryOptions).map(o => ({value: o, text: o})) });

            sniSelect.on('change', sortAndRender);
            categorySelect.on('change', sortAndRender);
        }

        function sortData(data, method) {
            const [key, direction] = method.split('-');
            return data.sort((a, b) => {
                let valA, valB;
                switch (key) {
                    case 'name':
                        valA = a.company?.name?.toLowerCase() || '';
                        valB = b.company?.name?.toLowerCase() || '';
                        break;
                    case 'revenue':
                    case 'profit_after_financial_items':
                    case 'net_profit':
                    case 'total_assets':
                        valA = a.financials?.[key] ?? -Infinity;
                        valB = b.financials?.[key] ?? -Infinity;
                        break;
                    case 'date':
                        valA = new Date(a.company?.registration_date || 0).getTime();
                        valB = new Date(b.company?.registration_date || 0).getTime();
                        break;
                    default: return 0;
                }
                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        function renderCards(data) {
            recordCount.innerHTML = `<span data-translate="records">${translations[currentLang].records}</span>: ${data.length}`;
            if (data.length === 0) {
                cardsContainer.innerHTML = `<div class="alert alert-warning">${translations[currentLang].no_data}</div>`;
                return;
            }
            const html = data.slice(0, 500).map(item => buildCard(item)).join('');
            cardsContainer.innerHTML = html + (data.length > 500 ? `<div class="alert alert-info">${translations[currentLang].showing_first_500}</div>` : '');
        }

        function buildCard(item) {
            const c = item.company || {};
            const ct = item.contact || {};
            const f = item.financials || {};
            const i = item.industry || {};
            const t = item.tax_info || {};
            const b = item.board || [];

            const isPositive = (f.net_profit || 0) >= 0;
            const profitClass = isPositive ? 'profit-plus' : 'profit-minus';
            const statusText = c.status === 'Bolaget √§r aktivt' ? translations[currentLang].active : (c.status || translations[currentLang].unknown);
            const statusHtml = c.status === 'Bolaget √§r aktivt'
                ? `<span class="status-active">${statusText}</span>`
                : `<span class="status-inactive">${statusText}</span>`;
            
            const formatBool = (val) => {
                if (val === undefined || val === null) return '<span class="text-muted">-</span>';
                return val ? `<span class="text-success fw-bold">${translations[currentLang].yes}</span>` : `<span class="text-danger">${translations[currentLang].no}</span>`;
            };

            const boardMemberHtml = b.length > 0 ? b.map(m => {
                const address = m.address ? [m.address.street, m.address.postal_code, m.address.city].filter(Boolean).join(', ') : '-';
                return `<div class="board-member">
                            <strong>${m.name || '-'}</strong> (${m.role || '?'}) - ${m.age || '?'} ${translations[currentLang].years}<br>
                            <span class="text-muted small">
                                <i class="bi bi-telephone"></i> ${m.phone || '-'}<br>
                                <i class="bi bi-geo-alt"></i> ${address}
                            </span>
                        </div>`;
            }).join('') : `<p class="small text-muted fst-italic">${translations[currentLang].no_board_data}</p>`;

            const categoriesHtml = (i.categories && i.categories.length) 
                ? i.categories.map(cat => `<span class="badge bg-light text-dark border me-1 mb-1">${cat}</span>`).join('')
                : '-';
            
            const sniDescriptionHtml = (i.sni_description || '').split('\n').map(line => `<div class="small">${line}</div>`).join('');

            return `
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <div>
                        <h5 class="mb-0 d-inline-block me-2 text-primary fw-bold">${c.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</h5>
                        ${statusHtml}
                    </div>
                    <code class="text-muted fw-bold">${c.org_number || ''}</code>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-lg-4 col-md-6">
                            <div class="section-title">${translations[currentLang].company_and_contacts}</div>
                            <ul class="list-unstyled small">
                                <li><span class="data-label">${translations[currentLang].form}</span> ${c.legal_form || '-'}</li>
                                <li><span class="data-label">${translations[currentLang].registration}</span> ${c.registration_date || '-'}</li>
                                <li><span class="data-label">${translations[currentLang].phone}</span> ${ct.phone || '-'}</li>
                                <li><span class="data-label">${translations[currentLang].address}</span> ${ct.address || '-'}</li>
                                <li><span class="data-label">${translations[currentLang].city_county}</span> ${ct.city || '-'}, ${ct.county || '-'}</li>
                            </ul>
                            <div class="section-title mt-3">${translations[currentLang].taxes}</div>
                             <ul class="list-unstyled small d-flex gap-4">
                                <li><span class="data-label">F-skatt:</span> ${formatBool(t.f_skatt)}</li>
                                <li><span class="data-label">VAT:</span> ${formatBool(t.vat_registered)}</li>
                                <li><span class="data-label">${translations[currentLang].employer}</span> ${formatBool(t.employer_registered)}</li>
                            </ul>
                        </div>
                        <div class="col-lg-4 col-md-6">
                            <div class="section-title">${translations[currentLang].financials} (${f.period || 'N/A'})</div>
                            <ul class="list-unstyled small">
                                <li><span class="data-label">${translations[currentLang].revenue}:</span> ${f.revenue != null ? sekFormatter.format(f.revenue) : '-'}</li>
                                <li><span class="data-label">${translations[currentLang].profit_before_tax}:</span> ${f.profit_after_financial_items != null ? sekFormatter.format(f.profit_after_financial_items) : '-'}</li>
                                <li><span class="data-label">${translations[currentLang].net_profit}:</span> <span class="${profitClass}">${f.net_profit != null ? sekFormatter.format(f.net_profit) : '-'}</span></li>
                                <li><span class="data-label">${translations[currentLang].total_assets}:</span> ${f.total_assets != null ? sekFormatter.format(f.total_assets) : '-'}</li>
                            </ul>
                             <div class="section-title mt-3">${translations[currentLang].categories}</div>
                             <div class="small">${categoriesHtml}</div>
                        </div>
                        <div class="col-lg-4 col-md-12">
                            <div class="section-title">${translations[currentLang].industry_and_board}</div>
                            <p class="small text-muted mb-2 fst-italic">${i.activity_description || '-'}</p>
                            <div class="mt-3">
                                <strong class="small text-dark">${translations[currentLang].sni_code.replace('{code}', i.sni_code || '-')}</strong>
                                <div class="text-muted">${sniDescriptionHtml || '-'}</div>
                            </div>
                            <div class="section-title mt-3">${translations[currentLang].board}</div>
                            <div class="small">${boardMemberHtml}</div>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }

        function applyFilters() {
            const term = searchInput.value.toLowerCase();

            const getFilterValue = (id, defaultValue) => {
                const value = parseFloat(document.getElementById(id).value);
                return isNaN(value) ? defaultValue : value;
            };

            const filters = {
                revenue: { min: getFilterValue('revenue-min', -Infinity), max: getFilterValue('revenue-max', Infinity) },
                profit_after_financial_items: { min: getFilterValue('profit_after_financial_items-min', -Infinity), max: getFilterValue('profit_after_financial_items-max', Infinity) },
                net_profit: { min: getFilterValue('net_profit-min', -Infinity), max: getFilterValue('net_profit-max', Infinity) },
                total_assets: { min: getFilterValue('total_assets-min', -Infinity), max: getFilterValue('total_assets-max', Infinity) },
                companyPhone: document.getElementById('company-phone-filter').value,
                boardPhone: document.getElementById('board-phone-filter').value,
                sni: sniSelect ? sniSelect.getValue() : [],
                categories: categorySelect ? categorySelect.getValue() : []
            };

            let filteredData = allData.filter(item => {
                if (term) {
                    const name = item.company?.name?.toLowerCase() || '';
                    const org = item.company?.org_number || '';
                    const city = item.contact?.city?.toLowerCase() || '';
                    if (!name.includes(term) && !org.includes(term) && !city.includes(term)) return false;
                }

                for (const key of ['revenue', 'profit_after_financial_items', 'net_profit', 'total_assets']) {
                    const value = item.financials?.[key] ?? 0; // Treat null/undefined as 0
                    if (value < filters[key].min || value > filters[key].max) {
                        return false;
                    }
                }

                const hasCompanyPhone = !!item.contact?.phone;
                if (filters.companyPhone === 'yes' && !hasCompanyPhone) return false;
                if (filters.companyPhone === 'no' && hasCompanyPhone) return false;

                const hasBoardPhone = item.board?.some(member => !!member.phone);
                if (filters.boardPhone === 'yes' && !hasBoardPhone) return false;
                if (filters.boardPhone === 'no' && hasBoardPhone) return false;

                if (filters.sni.length > 0) {
                    const itemSni = item.industry?.sni_description?.split('\n').map(d => d.trim()) || [];
                    if (!itemSni.some(desc => filters.sni.includes(desc))) return false;
                }

                if (filters.categories.length > 0) {
                    const itemCats = item.industry?.categories || [];
                    if (!itemCats.some(cat => filters.categories.includes(cat))) return false;
                }

                return true;
            });
            return filteredData;
        }
        
        function sortAndRender() {
            let dataToRender = applyFilters();
            dataToRender = sortData(dataToRender, sortSelect.value);
            renderCards(dataToRender);
        }

        document.querySelectorAll('.filter-input, #searchInput, #sortSelect').forEach(el => {
            el.addEventListener('input', sortAndRender);
        });
        
        document.getElementById('lang-switcher').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                setLanguage(e.target.dataset.lang);
            }
        });

        setLanguage(currentLang);

    </script>
</body>
</html>